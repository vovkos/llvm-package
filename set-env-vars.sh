# apparently, the set of targets in a LLVM binary release is... kind of random.
# so we might need to take llvm-tblgen from another release. hence, LLVM_BIN_VERSION

LLVM_VERSION=6.0.0
LLVM_BIN_VERSION=6.0.0
LLVM_SRC_TAR=llvm-$LLVM_VERSION.src.tar.xz
LLVM_SRC_URL=http://releases.llvm.org/$LLVM_VERSION/$LLVM_SRC_TAR

if [ $TRAVIS_OS_NAME == "osx" ]; then
	CPU_COUNT=$(sysctl -n hw.ncpu)
	CPU_SUFFIX=
	CC_SUFFIX=
	LLVM_BIN_TAR_SUBDIR=clang+llvm-$LLVM_BIN_VERSION-final-x86_64-apple-darwin
	LLVM_BIN_TAR=clang+llvm-$LLVM_BIN_VERSION-x86_64-apple-darwin.tar.xz
else
	CPU_COUNT=$(nproc)
	CPU_SUFFIX=-$TARGET_CPU
	CC_SUFFIX=-$CC
	LLVM_BIN_TAR_SUBDIR=clang+llvm-$LLVM_BIN_VERSION-x86_64-linux-gnu-ubuntu-14.04
	LLVM_BIN_TAR=$LLVM_BIN_TAR_SUBDIR.tar.xz
fi

echo CPU_COUNT: $CPU_COUNT

LLVM_BIN_URL=http://releases.llvm.org/$LLVM_BIN_VERSION/$LLVM_BIN_TAR

if [ $TARGET_CPU == "x86" ]; then
	LLVM_BUILD_32_BITS=ON
else
	LLVM_BUILD_32_BITS=OFF
fi

# packing a debug build with xz takes too much time, travis ci times out

if [ $BUILD_CONFIGURATION == "Debug" ]; then
	DEBUG_SUFFIX=-dbg
	TAR_COMPRESSION=z
	TAR_FILE_EXT=.gz
else
	DEBUG_SUFFIX=
	TAR_COMPRESSION=J
	TAR_FILE_EXT=.xz
fi

THIS_DIR=`pwd`
LLVM_RELEASE_NAME=llvm-$LLVM_VERSION-$TRAVIS_OS_NAME$CPU_SUFFIX$CC_SUFFIX$DEBUG_SUFFIX
LLVM_RELEASE_DIR=$THIS_DIR/$LLVM_RELEASE_NAME
LLVM_RELEASE_FILE=$LLVM_RELEASE_NAME.tar$TAR_FILE_EXT

CMAKE_FLAGS=(
	-DCMAKE_INSTALL_PREFIX=$LLVM_RELEASE_DIR
	-DCMAKE_BUILD_TYPE=$BUILD_CONFIGURATION
	-DLLVM_BUILD_32_BITS=$LLVM_BUILD_32_BITS
	-DLLVM_TABLEGEN=$THIS_DIR/llvm-tblgen
	-DLLVM_TARGETS_TO_BUILD=X86
	-DLLVM_ENABLE_TERMINFO=OFF
	-DLLVM_ENABLE_ZLIB=OFF
	-DLLVM_INCLUDE_DOCS=OFF
	-DLLVM_INCLUDE_EXAMPLES=OFF
	-DLLVM_INCLUDE_TESTS=OFF
	-DLLVM_INCLUDE_TOOLS=OFF
	-DLLVM_INCLUDE_UTILS=OFF
	)

CMAKE_FLAGS=${CMAKE_FLAGS[*]}

